void runStages(String tag) {

    docker.image(tag).inside("--privileged=true") {
	
		stage('Generate the build'){
		
				sh '''				
				    dir=$(pwd)
					mkdir $dir/ci/ova_automation
					wget https://artifactory.core.rcsops.com:443/artifactory/core-generic-local/tas_middleware_1.0.0.44.ova
					git clone https://madduv:487367d96125a05c961180a4d9ca530f012481c1@github.emcrubicon.com/AAI/ova_scripts.git
					cd ova_scripts
					git fetch origin
					git checkout -b test1 origin/ova_automation
					cp install_middleware_svc.sh $dir/ci/ova_automation
					cp ova_automation/middleware/* $dir/ci/ova_automation
					cp ova_automation/pyvmomi_scripts/* $dir/ci/ova_automation
					cd $dir
				    virtualenv venv -p python3
					source venv/bin/activate
					python3 setup.py install
					pip install paramiko
					pip install pyVim
					pip install pyVmomi
					chmod -R 777 build.sh
					./build.sh
					cd $dir/dist
					file=`ls | grep ".gz"`
					
					cd $dir/ci/ova_automation
					
					python3 deploy_ova.py -s '10.100.28.108' -o 443 -u 'anuras1@vsint.local' -p 'Sylu123!' --datacenter 'VC8_DC' --datastore '5TBDatastore' --resource-pool 'xStreamHA' --ova-path $dir/tas_middleware_1.0.0.44.ova --configpath $dir/ci/ova_automation/config.yaml
					
					
					python3 power_cycles.py -s '10.100.28.108' -o 443 -u 'anuras1@vsint.local' -p 'Sylu123!' --vmname 'middleware_vm'  --powercycle 'power_on'
					
		
					python3 remote_operations.py $dir/ci/ova_automation $dir/dist/$file /home/install/$file
					
					mkdir ovf
					
					python3 power_cycles.py -s '10.100.28.108' -o 443 -u 'anuras1@vsint.local' -p 'Sylu123!' --vmname 'middleware_vm' --powercycle 'power_off'
					
					python3 export_vm.py -s '10.100.28.108' -o 443 -u 'anuras1@vsint.local' -p 'Sylu123!' --vmname 'middleware_vm' -w $dir/ci/ova_automation/ovf
					
					python3 power_cycles.py -s '10.100.28.108' -o 443 -u 'anuras1@vsint.local' -p 'Sylu123!' --vmname 'middleware_vm'  --powercycle 'power_on'
					
					cd $dir/ci/ova_automation/ovf/*
					
					ovftool middleware_vm.ovf middleware_vm.ova
					
					cd $dir
					
				'''
				def taglist = sh script: 'git tag', returnStdout: true
				
				String[] splitData = taglist.split("\n");
				for (String eachSplit : splitData) {
					if (eachSplit.startsWith("v")) {
					lasttag = eachSplit.substring(1);
					}
				}
				
				
				withCredentials([usernamePassword(credentialsId: 'Jenkins Artifactory', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
				
					def lastbuild = Jenkins.instance.getItemByFullName("${env.JOB_BASE_NAME}").getLastSuccessfulBuild().toString()
					
					def lastbuildnumber = lastbuild.substring(lastbuild.indexOf('#') + 1)
					
					int newbuildnumber = lastbuildnumber.toInteger() + 1
									   
					def ver = "1.0.0" + "." + newbuildnumber
					
					
					sh """
					    dir=\$(pwd)
						cd \$dir/ci/ova_automation/ovf/*
						curl -u $USERNAME:$PASSWORD -T 'middleware_vm.ova' 'https://artifactory.core.rcsops.com/artifactory/core-generic-local/tas_middleware_${ver}.ova'
					"""
				}
			   
		}
		
    }
}


def vs = new devops.VariousStuff1().configure([notifyRecipients : 'vijaymaddukuri@yahoo.com'])

vs.try_node('docker_engine') {

    try {
        jdk = tool name: 'OpenJDK 1.8.0', type: 'hudson.model.JDK'
		deleteDir()
	
        checkout scm

        imageTag = vs.ensureDockerImage('devops/build-image')

        runStages(imageTag)


    } catch(e) {

        def color = 'danger'
        def err_message = "Job: ${JOB_NAME}:${BUILD_NUMBER} got an exception during Build stage: " + e.toString()
        def info_message = "Job URL: ${BUILD_URL}"
        throw (e)
    }
}
