# ------------------------------------------------------------------------------
# Copyright (C) 2016-2017 DELL EMC Corporation. All Rights Reserved.

# This software contains the intellectual property of DELL EMC Corporation
# or is licensed to DELL EMC Corporation from third parties.  Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of DELL  EMC.

# ------------------------------------------------------------------------------

-
    name: 'NSX - {{ step }} - Enable NSX Edge'
    hosts: '{{ vms }}'
    tags:
        - 'NSX - {{ step }} - Enable NSX Edge'
    tasks:
        -
            name: 'NSX - {{ step }} - Get Loadbalancer Edge ID'
            tags:
                # Tagging here so it is called automatically when configure nsx loadbalancer runs
                - 'NSX - EPB-200-210 - Configure Load Balancer'
            delegate_to: localhost
            ehc_script_agent:
                method_name: getEdgeId
                method_params:
                    nsxManager: '{{ nsxManager }}'
                    edgeName: '{{ nsx_load_balancer_load_balancer_name }}'
                module_name: configureLoadBalancer
                package_name: nsx
            register: edgeId
# We are Assinging Virtual IP during load balancer configuration. So not required here
#        -
#            name: assignVIPs
#            tags:
#                - assignVIPs
#            delegate_to: localhost
#            ehc_script_agent:
#                method_name: assignVirtualServerIP
#                method_params:
#                    nsxManager: '{{ nsxManager }}'
#                    edgeId: '{{edgeId}}'
#                    virtualServerIP:
#                        vNIC:
#                            -
#                                nicID: 0
#                                addressGroups:
#                                    -
#                                        subnetMask: '{{common.management_network_netmask}}'
#                                        subnetPrefixLength: 24
#                                        primaryAddress: 10.247.69.141
#                                        secondaryAddresses:
#                                            - 10.247.69.142
#                                            - 10.247.69.143
#                                            - 10.247.69.144
#                                            - 10.247.69.145
#                module_name: configureLoadBalancer
#                package_name: nsx
        -
            name: 'NSX - {{ step }} - Enable NSX Edge'
            delegate_to: localhost
            ehc_script_agent:
                method_name: enabledNSXEdge
                method_params:
                    nsxManager: '{{ nsxManager }}'
                    edgeId: '{{ edgeId.data }}'
                    edgeEnabled: true
                module_name: configureLoadBalancer
                package_name: nsx
            register: enabledNSXEdgeResult
            failed_when: not enabledNSXEdgeResult.data is defined or enabledNSXEdgeResult.data.err_message is defined or not enabledNSXEdgeResult.data.status is defined or enabledNSXEdgeResult.data.status == false
            changed_when: enabledNSXEdgeResult.data is defined and not enabledNSXEdgeResult.data.err_message is defined and enabledNSXEdgeResult.data.status is defined and enabledNSXEdgeResult.data.status == true
